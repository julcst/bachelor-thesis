
\chapter{Constructing a Reference Pathtracer}
\label{chap:pathtracing}

\section{Solving the Rendering Equation}

As always in rendering, we are interested in solving the rendering equation, which describes how light interacts with surfaces in a scene and was first introduced by \textcite{kajiya1986}.
The rendering equation is given by:

\begin{equation}
    L_o(\vec{x}, \vec{\omega}_o) = L_e(\vec{x}, \vec{\omega}_o) + \int_{\Omega} f(\vec{\omega}_i, \vec{x}, \vec{\omega}_o) L_i(\vec{x}, \vec{\omega}_i) \cos(\theta_i) d\vec{\omega}_i
\end{equation}

where $L_o$ is the outgoing radiance, $L_e$ is the emitted radiance, $f$ is the bidirectional reflectance distribution function (BRDF), and $L_i$ is the incoming radiance from direction $\omega_i$.

\section{Monte Carlo Integration}

The rendering equation is an infinite recursive integral over all possible light paths, for which no closed-form solution exists in general.
Hence, to solve it we need to resort to numerical integration strategies.
Deterministic integration methods suffer from the curse of dimensionality as the rendering equation is notoriously high dimensional.
Thus, we utilize probabilistic approaches to solve it, in my reference implementation I use Monte Carlo integration, which was first introduced to rendering by \textcite{kajiya1986}.
The idea is, to sample the integral using random samples drawn from a probability distribution, which ideally is chosen as proportional to the integrand as possible.

Applying this to the rendering equation, we can formulate an estimator for the outgoing radiance $L_o$:

\begin{equation}
    \estimator{L_o(\vec{x}, \vec{\omega}_o)} = L_e(\vec{x}, \vec{\omega}_o) + \sum_{i=1}^{N} \frac{f(\vec{\hat{\omega}}_i, \vec{x}, \vec{\omega}_o) \cos(\hat{\theta}_i)}{p(\vec{\hat{\omega}}_i)} L_i(\vec{x}, \vec{\hat{\omega}}_i), \quad \vec{\hat{\omega}}_i \sim p
\end{equation}

This is an unbiased estimator for the rendering equation, as can be easily shown:

\begin{equation}
    \expectation{\estimator{L_o(\vec{x}, \vec{\omega}_o)}} = L_e(\vec{x}, \vec{\omega}_o) + \sum_{i=1}^{N} \frac{f(\vec{\hat{\omega}}_i, \vec{x}, \vec{\omega}_o) \cos(\hat{\theta}_i) p(\vec{\hat{\omega}}_i)}{p(\vec{\hat{\omega}}_i)} L_i(\vec{x}, \vec{\hat{\omega}}_i) = L_o(\vec{x}, \vec{\omega}_o)
\end{equation}

To handle the infinite recursion without introducing bias, I use Russian roulette termination \bcite{veach1997}, which probabilistically terminates the recursion based on the contribution of the current path segment:

\begin{equation}
    X =
    \begin{cases}
        \frac{L_o(\vec{x}, \vec{\omega}_o)}{p_\mathrm{continue}} & \text{with probability } p_\mathrm{continue} \\
        0 & \text{with probability } 1 - p_\mathrm{continue}
    \end{cases}
\end{equation}

I choose $p_\mathrm{continue}$ proportional to the relative luminance $Y$ of the contribution of the current path segment, which measures the perceived linear brightness.

% Thus, the radiance of a complete path is calculated as:

% \begin{equation}
%     L_o(\vec{x}, \vec{\omega}_o) = \frac{1}{N} \sum_{i=1}^{N} X_i
% \end{equation}

\section{Randomized Quasi-Monte Carlo Integration}

I use the scrambled Sobol' sequence from cuRAND \bcite{nvidiacorporation2024} which is based on the work of \textcite{owen2008}.
Furthermore, I employ the same technique as the \textcite{blenderfoundation} and only precompute a single Sobol' sequence for the entire scene, which is then decorrelated between pixels using constant random per-pixel shifts modulo 1, also known as Cranley-Patterson rotations \bcite{cranley1976}.
The Sobol' sequence is regularly recomputed in batches on the GPU to allow for unlimited progressive rendering, the per pixel  shifts are only recomputed on frame buffer resize, which makes the technique relatively lightweight.

\section{Principled BRDF}

As a material model I use a simplified physically based model, which is inspired by the Disney principled BRDF \bcite{burley2012} and conformant with the glTF PBR specification \bcite{thekhronosr3dformatsworkinggroup2021}.
I restrict myself to the diffuse, specular and transmission components, as they can already cover a wide range of interesting materials and suffice to showcase the strengths and weaknesses of the subsequent techniques.

\section{Importance Sampling}

\section{Multiple Importance Sampling}