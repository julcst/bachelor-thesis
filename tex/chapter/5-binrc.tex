
\chapter{Bidirectional Radiance Caching}
\label{chap:bidirectional_caching}

\section{A General Theoretical Framework for Radiance Caching}
Before proposing new radiance caching techniques, I first want to take a step back and analyze radiance caching in general.

Radiance caching generally can be broken down into four steps:

\begin{enumerate}
    \item \textbf{Training}
    \begin{enumerate}
        \item \textbf{Query Prediction} First, we want to predict potential queries $\hat{q} = (\vec{x}, \vec{\omega}_o)$ according to a distribution $\hat{Q}(\hat{q})$.
        \item \textbf{Radiance Estimation} Given a predicted query $\hat{q}$, we want to estimate the outgoing radiance $L_o(\hat{q})$ at that query.
        For this, we can use any possible combination of radiance estimation techniques, such as path tracing, light tracing, photon mapping or Vertex Connection and Merging (VCM).
    \end{enumerate}
    \item \textbf{Inference}
    \begin{enumerate}
        \item \textbf{Query Sampling} We sample queries $q = (\vec{x}, \vec{\omega}_o)$ according to a distribution $Q(q)$.
        \item \textbf{Interpolation} Given a query $q$, we want to approximate the outgoing radiance $\hat{L}_o(q)$ by interpolating the radiance estimates of spatiotemporally nearby query predictions $\hat{q}$.
        We can use any combination of storing and interpolation technique for this, such as nearest neighbor, linear interpolation or, in our case, the NRC.
        Note however, that this step generally introduces \textbf{bias}.
    \end{enumerate}
\end{enumerate}

\textbf{Note:} Using this framework we can observe that the \textbf{cache efficiency} is optimal if the query prediction distribution $\hat{Q}(\hat{q})$ is equal to the query sampling distribution $Q(q)$.
Conversely, if we sample a query $q^*$ that can not be predicted by the query predictor (i.e. $\hat{Q}(q^*)=0$), we introduce fundamental bias into the radiance cache $\hat{L}_o(q^*)$, because the radiance cache will not contain an accurate radiance estimate for that query.
This happens, whenever the support of the query sampling distribution $Q$ is not contained in the support of the query prediction distribution $\hat{Q}$, i.e. $\supp(Q) \not\subseteq \supp(\hat{Q})$.

\textbf{Discussion:} It may be possible, to derive an unbiased radiance cache for diffuse queries by storing the radiance estimates $L_o(\hat{q})$ in a spatial data structure and reconnecting the queries $q$ to the query predictions $\hat{q}$ similarly to Vertex Connection and Merging (VCM). % TODO: Check and cite

\section{The Path Space Integral Formulation}
To be able to robustly derive the following radiance estimators, I will use an alternative but equivalent formulation of the rendering equation as an integral over the path space, which was first introduced by \textcite{veach1997}.

A path $\bar{x}$ of length $n$ is defined as a sequence of vertices $\vec{x}_0 \vec{x}_1 \dots \vec{x}_n$.
Let the space of all paths of length $n$ be $X_n$ and the space of all paths $X = \bigcup_{n=1}^{\infty} X_n$.
Then, the path space integral formulation of the rendering equation is given by:
\begin{equation}
\label{eq:path_space_integral}
\begin{aligned}
    L_o(x, \wo) = \sum_{n=1}^{\infty} \int_{X_n} L_e(\pdir{0}{1}) \G{0}{1} \prod_{i=1}^{n - 1} \f{i-1}{i}{i+1} \G{i}{i+1}\\
    f(\vec{x}_{n-1} \pto \vec{x}_n \pto \vec{x}) \G{n-1}{n} f(\vec{x}_n \pto \vec{x}, \wo) \ \diff A(\vec{x}_0) \dots \diff A(\vec{x}_n)
\end{aligned}
\end{equation}
The arrow notation $\pto$ denotes a path segment, i.e. $L(\vec{x} \pto \vec{y})=L(\vec{x}, \vec{y} - \vec{x})$, and $f(\vec{x} \pto \vec{y} \pto \vec{z})=f(\vec{y} - \vec{x}, \vec{y}, \vec{z} - \vec{y})$ and $G(\vec{x} \leftrightarrow \vec{y})$ models the radiance transfer between the vertices $\vec{x}$ and $\vec{y}$:
\begin{equation}
\label{eq:transfer}
G(\vec{x} \leftrightarrow \vec{y}) = V(\vec{x} \leftrightarrow \vec{y}) \frac{\cos \theta_{\vec{x} \to \vec{y}} \cos \theta_{\vec{y} \to \vec{x}}}{\|\vec{y} - \vec{x}\|^2},
\end{equation}
where $V(\vec{x} \leftrightarrow \vec{y}) \in \{0,1\}$ defines visibility and $\theta$ denotes the respective angles of incidence.
The integral is measured over the surface of the scene $A(\vec{x})$.
Note, that the original formulation has been slightly adapted to estimate \emph{radiance} instead of \emph{intensity}.

The main advantage of this formulation is that the individual vertices are independent of each other, this for example allows for bidirectional sampling.
An essential tool for the derivation of path samplers is the conversion between area and solid angle measure, given by:
\begin{equation}
\label{eq:area_solid_angle}
\diff A(\vec{y}) = \frac{\|\vec{y} - \vec{x}\|^2}{\cos \theta_{\vec{y}}} \diff \omega(\vec{x}\pto\vec{y}),
\end{equation}



\section{Inference}
Using this framework a simple inference scheme trivially emerges from the Rendering Equation (\autoref{eq:rendering_equation}):
\begin{equation}
\label{eq:inference}
    I(\wo) = \left( \prod_{i=1}^{N} \frac{f(\wi, \wo) \cos(\theta_i)}{p(\wi \mid \wo)} \right) \cdot \hat{L}_o(q), \quad T_n = \prod_{i=1}^{N} \frac{f(\ptrip{i-1}{i}{i+1}) \cos \theta_{i \veryshortarrow i+1}}{p(\pdir{i}{i+1} \mid \pdir{i-1}{i})}
\end{equation}

Note, that Russian Roulette Termination (\autoref{eq:rr}) is not to be applied here, as we terminate the path with a valid radiance estimate.

\section{Path Tracing}

\section{Bidirectional Training}

\section{Light Tracing}

\section{Balancing}

\section{Path Spaced Denoised Sparse Photon Mapping}

\section{Hardware Accelerated Vertex Connection and Merging}